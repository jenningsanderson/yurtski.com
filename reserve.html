<html>
<head>

  <!-- Include the necessary calendar -->
  <link href="https://api.mapbox.com/mapbox-assembly/v0.20.0/assembly.min.css" rel="stylesheet">
  <script async defer src="https://api.mapbox.com/mapbox-assembly/v0.20.0/assembly.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.12.2/d3.min.js"></script>

  <link rel="stylesheet" href="css/reserve.css">

</head>
<body>

  <section class="limiter">

    <h3>Total number of people? (Including You)</h3>
    <div class='select-container'>
      <select id='peopleSelector' class='select select--stroke select--stroke--2'>
        <option>1</option>
        <option selected="selected">2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
        <option>6</option>
        <option>7</option>
        <option>8</option>
      </select>
      <div class='select-arrow'></div>
    </div>

    <h3 class="txt-h3">When?</h3>
    <div id="datePicker"></div>

    <p id="newTrip"></p>

    <p class="border border--orange" style="display:none;" id="warning"></p>

    <h3 class="txt-h3">Gear Haul?</h3>
    <p>Have us deliver your equipment to the yurts via snowmobile for $65 / person. </p>

    <p>We will meet you at the trailhead at 9am on the day your group goes in and then at the Yurts by 10am on the day you plan to leave.</p>
    </p>

    <label class='checkbox-container'>
        <input type='checkbox' />
        <div class='checkbox mr6'>
          <svg class='icon'><use xlink:href='#icon-check' /></svg>
        </div>
        <p>Yes, we'd like to include a Gear Haul for <span class="txt-bold" id="count"> 2 </span> people.</p>
      </label>

    <option>

  </section>

  <script type="text/javascript">

    d3.json("http://localhost:8080/reservations.json",function(err, trips){
      if(err) throw err

      console.log(trips)

      var daysIn = []
      var daysOut = []
      var daysBooked = []
      var singleNights = []

      trips.forEach(function(trip){
        // console.log(trip.nights)
        // var dIn = flatpickr.parseDate(trip.nights[0], "Y-m-d")
        daysIn.push( trip.nights[0] )

        var lastNight = flatpickr.parseDate(trip.nights[trip.nights.length-1],"Y-m-d")
        var dOut = new Date(lastNight);
        dOut.setDate(lastNight.getDate()+1)

        daysOut.push( flatpickr.formatDate(dOut, "Y-m-d") )

        if (trip.nights.length>1){
          for(var i=1; i<trip.nights.length; i++){
            daysBooked.push(trip.nights[i])
          }
        }else{
          singleNights.push([trip.nights[0],flatpickr.formatDate(dOut,"Y-m-d")])
        }
      })

      console.log("daysIn: " + daysIn)
      console.log("daysOut: " + daysOut)

      function warn(string){
        var w = document.getElementById('warning')
        w.innerHTML = string
        w.style.display='block'
      }

      function hideWarning(){
        document.getElementById('warning').style.display='none';
      }

      var calendar = flatpickr("#datePicker", {
        minDate: "2018-12-01",
        maxDate: "2019-03-31",
        mode: "range",
        inline: true,
        disable: daysBooked,
        onDayCreate: function(dObj, dStr, fp, dayElem){
          if (daysIn.indexOf(flatpickr.formatDate(dayElem.dateObj,"Y-m-d")) > -1){
            dayElem.innerHTML += "<span class='group'></span>";
          }
          if (daysOut.indexOf(flatpickr.formatDate(dayElem.dateObj,"Y-m-d")) > -1){
            dayElem.innerHTML += "<span class='group out'></span>";
          }
        },
        onValueUpdate: function(selectedDates, dateStr, instance){
          var warning = document.getElementById('warning')
          console.log("dates: " + selectedDates)
          if (selectedDates.length > 1){
            if (selectedDates[0].getDate()===selectedDates[1].getDate()){
              console.warn("Error: Same Date")
              warn("Please start your trip on the day you would like to go into the yurt and end your trip on the day you plan to checkout.")
              calendar.clear();
              return;
            }

            //Scenario for one night trips?
            if(singleNights.length){
              //If there are single night trips, we just need to confirm that we're not over-stepping them
              for(var i in singleNights){
                var nightIn = flatpickr.parseDate(singleNights[i][0], "Y-m-d")
                var nightOut = flatpickr.parseDate(singleNights[i][1], "Y-m-d")
                if ((selectedDates[0] <= nightIn) && (selectedDates[1] >= nightOut)){
                  calendar.clear()
                  warn("Your trip cannot overlap another trip")
                  return;
                }
              }
            }

            //Otherwise, we have a successful trip
            hideWarning();
            document.getElementById('newTrip').innerHTML = "Going into Yurt on <strong>" +
             flatpickr.formatDate(selectedDates[0],"D, M j") + "</strong> and checking out by 11:00am on <strong>" +
              flatpickr.formatDate(selectedDates[1],"D, M j") + "</strong>"

          }

        }
      });
    })






    document.getElementById('peopleSelector').addEventListener('change',function(e){
      console.log("People Changed: " + e.target.value)
      document.getElementById('count').innerHTML = e.target.value
    })
  </script>

</body>
</html>
